# A shell script to launch pytest in parallel,
# in their own processes so that they do not share test fixtures
# Sharing the same database will cause tests to mangle each other.
# Currently it runs 5 tests per process
# The outputs of the tests are written to results_xa*
# This script exits immediately after the pytest processes are 
# created, it does not wait on the children

if [ $# -lt 0 ] ; then
  number_of_workers = 5
else
  number_of_workers = $1
fi

echo "Number of workers $number_of_workers"


# Clean previous results
rm results_*

#temporary files for lists of test files and commands
ALL_GROUPS=`mktemp -t jobmon_ptest.XXXXXXXX`
here=`pwd`
find tests -name "groups_*.test" > $ALL_GROUPS

for file in `cat $ALL_GROUPS` ; do
  suffix=`echo $file| sed -e "s/.*_//" | sed -e "s/.test//"`
  cat $file
  echo
  pytest `cat $file` > results_$suffix 2>&1 &
done

#rm $ALL_GROUPS
