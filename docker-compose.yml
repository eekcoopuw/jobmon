version: '3'

services:
  jsm:
    build: .
    image: jobmon
    ports:
        - "4456:3456"
        - "4457:3457"

    entrypoint:
        - ./wait-for-db.sh
        - db
    command: [
        "jobmon",
        "--verbose",
        "start", "job_state_manager"]
    links:
        - db
    logging:
        options:
            max-size: "100m"
            max-file: "10"
  jqs:
    image: jobmon
    ports:
        - "4458:3458"
    entrypoint:
        - ./wait-for-db.sh
        - db
    command: [
        "jobmon",
        "--verbose",
        "start", "job_query_server"]
    links:
        - db
    logging:
        options:
            max-size: "100m"
            max-file: "10"
  initdb:
    image: jobmon
    entrypoint:
        - ./wait-for-db.sh
        - db
    command: ["jobmon", "--verbose", "initdb"]
    links:
        - db
  db:
    image: mysql
    ports:
        - "3306:3306"
    environment:
        MYSQL_ROOT_PASSWORD: docker
        MYSQL_DATABASE: docker
        MYSQL_USER: docker
        MYSQL_PASSWORD: docker
    volumes:
        - mysql-jobmon-cavy:/var/lib/mysql

volumes:
    mysql-jobmon-cavy: {}
